# Elasticsearch

[Elasticsearch](https://www.elastic.co/elasticsearch) is a search engine based on the Lucene library. It provides a distributed, multitenant-capable full-text search engine with an HTTP web interface and schema-free JSON documents.

In this tutorial, we will install the elasticsearch service, populate it with some data and create a microservice is NodeJS that will enable us to easily query elasticsearch and get relevant documents.

## Prerequisites

- NodeJS version 10 or greater

  To test that your nodejs version is correct, run `node --version` in the command line.


## Tools used in the tutorial

### NodeJS Elasticsearch Microservice

In this tutorial, we will use the NodeJS elasticsearch microservice template available [here](https://github.com/ErikNovak/template-nodejs-elasticsearch-microservice).

The template repository already has the majority of the microservices' configuration setup, the only thing that needs changing are elasticsearch (and dataset) related components.

### Dataset

If the student does not have its own dataset, one is already prepared and available in this folder. The [dataset.json](./dataset.json) file contains events extracted from [Event Registry](https://eventregistry.org). It was generated by querying Event Registry's API for events containing the `coronavirus`, `trade wars`, and `cybersecurity` concepts that appeared after 1st of February 2020. Ten events were extracted for each concept.

## Instructions

1. Install elasticsearch on your machine
    - Go to [https://www.elastic.co/guide/en/elasticsearch/reference/current/install-elasticsearch.html](https://www.elastic.co/guide/en/elasticsearch/reference/current/install-elasticsearch.html)

    - Use the apropriate installation process (follow the instructions)

    - Once installed make a request to `http://localhost:9200`

      The response should look similar to this:
      ```json
      {
        "name" : "burger",
        "cluster_name" : "elasticsearch",
        "cluster_uuid" : "JkJkYkOOSXaE7wIBjHVY3g",
        "version" : {
            "number" : "7.4.2",
            "build_flavor" : "default",
            "build_type" : "deb",
            "build_hash" : "2f90bbf7b93631e52bafb59b3b049cb44ec25e96",
            "build_date" : "2019-10-28T20:40:44.881551Z",
            "build_snapshot" : false,
            "lucene_version" : "8.2.0",
            "minimum_wire_compatibility_version" : "6.8.0",
            "minimum_index_compatibility_version" : "6.0.0-beta1"
        },
        "tagline" : "You Know, for Search"
      }
      ```

2. Create a new github repository by using the NodeJS Elasticsearch Microservice as the template repository and clone on your machine.
    - Go to [https://github.com/ErikNovak/template-nodejs-elasticsearch-microservice](https://github.com/ErikNovak/template-nodejs-elasticsearch-microservice)

    - Click `Use this template` and create a repository on your account using the template

    - Clone the repository on your machine (containing the elasticsearch service)

3. On your machine navigate to your new repository and follow the instructions stated in the readme of the Elasticsearch Microservice

    - Install the required nodejs packages with
      ```bash
      npm install
      ```

    - Setup the microservice by changing the required files

        - Follow instructions in `./src/config`
        - Use the create elasticsearch index script found in `./src/load/` to create and populate the elasticsearch index.

          In this step, use and format the `dataset.json` file (or your own dataset) to match the elasticsearch index mapping.

          Also, do not be afraid of modifying the mapping by consulting with the [elasticsearch mapping](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html) reference. First, start with something simple which will work. Afterwards, add additional components and frequently test if it works.


          **HINT:** If you are using the provided `dataset.json` file, you can prepare the documents variable by using the following code.

          ```javascript
          const dataset = require("./dataset");

          const documents = dataset.map((doc) => ({
              document_id: doc.uri,
              title: Object.values(doc.title)[0],
              date: new Date(doc.eventDate),
              language: Object.keys(doc.articleCounts)[0],
              wikipedia: doc.concepts.map((concept) => ({
                  uri: concept.uri,
                  label: Object.values(concept.label)[0]
              }))
          }));
          ```


4. Modify the file containing the routes responsible for making queries in elasticsearch.

    - In the terminal navigate to the repository folder and run
      ```bash
      npm run development
      ```
      This will start the microservice and run it in development mode. Each file change (and save) in the project folder will automatically reload the microservice, reflecting the newest changes.

    - In the repository go to `./src/routes/v1/elasticsearch.js`

    - This is the tricky part, but don't worry. Try to address all of the `TODO` comments in the code (think about if they are required for your use case). In addition, feel free to remove parts of the code if you don't need it.

      Help yourself with the provided URLs to the elasticsearch references as well as the elasticsearch [query DSL](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html) reference to better understand the query structure.

    - To check if the service is returning anything do the following:

        - Open your favorite browser.

        - Enter the following address: `http://localhost:3101/api/v1/documents?text={insert desired text}`. If required (and implemented), add additional query parameters to the URL, i.e. add `&limit=10&page=2` and similar parameters to the end of the address.

        - See what is the response.

5. Once you are happy with microservice, commit the changes to github.